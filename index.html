<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AudioTranscript - Transcripción de Audio a PDF</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🎙️</text></svg>"
    />

    <!-- Font Awesome CDN -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
      integrity="sha512-papm6Q6Qw1Q6Q6Qw1Q6Q6Qw1Q6Q6Qw1Q6Q6Qw1Q6Q6Qw1Q6Q6Qw1Q6Q6Qw1Q6Q6Qw1Q6Q6Qw1Q6Q6Qw1Q=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <link rel="stylesheet" href="static/styles.css" />
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1>🎙️ AudioTranscript</h1>
        <p>Transcripción inteligente de audio a PDF optimizada para español</p>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- API Status -->
        <div class="api-status">
          <div class="status-info">
            <div class="status-indicator" id="statusIndicator"></div>
            <div>
              <strong id="statusText">Verificando conexión...</strong>
              <div
                id="statusDetails"
                style="font-size: 14px; color: #6c757d"
              ></div>
            </div>
          </div>
          <button class="refresh-btn" onclick="checkApiStatus()">
            🔄 Actualizar
          </button>
        </div>

        <!-- Features -->
        <div class="features-grid">
          <div class="feature-card">
            <div class="feature-icon">🎯</div>
            <h3>Precisión en Español</h3>
            <p>Modelo Whisper optimizado específicamente para idioma español</p>
          </div>
          <div class="feature-card">
            <div class="feature-icon">📄</div>
            <h3>Múltiples Formatos</h3>
            <p>Genera documentos PDF y DOCX con metadatos completos</p>
          </div>
          <div class="feature-card">
            <div class="feature-icon">🚀</div>
            <h3>Archivos Grandes</h3>
            <p>Soporta archivos de hasta 1GB con procesamiento eficiente</p>
          </div>
        </div>

        <!-- Upload Section -->
        <div class="upload-section" id="uploadSection">
          <div class="upload-icon">📁</div>
          <h3>Selecciona tu archivo de audio</h3>
          <p>Arrastra y suelta aquí o haz clic para seleccionar</p>

          <div class="file-input-wrapper">
            <input
              type="file"
              id="audioFile"
              class="file-input"
              accept="audio/*,video/*"
            />
            <label for="audioFile" class="file-input-label">
              📂 Seleccionar Archivo
            </label>
          </div>

          <div class="file-info" id="fileInfo">
            <strong id="fileName"></strong><br />
            <span id="fileSize"></span> | <span id="fileType"></span>
          </div>
        </div>

        <!-- Supported Formats -->
        <div style="text-align: center; margin: 20px 0">
          <h4>📋 Formatos Soportados</h4>
          <div class="supported-formats">
            <span class="format-tag">MP3</span>
            <span class="format-tag">WAV</span>
            <span class="format-tag">FLAC</span>
            <span class="format-tag">M4A</span>
            <span class="format-tag">AAC</span>
            <span class="format-tag">OGG</span>
            <span class="format-tag">WMA</span>
            <span class="format-tag">MP4</span>
            <span class="format-tag">AVI</span>
            <span class="format-tag">MOV</span>
            <span class="format-tag">MKV</span>
            <span class="format-tag">WEBM</span>
          </div>
        </div>

        <!-- Options -->
        <div class="options-grid">
          <div class="option-card selected" data-format="pdf">
            <div class="option-icon">📄</div>
            <h4>PDF</h4>
            <p>Documento profesional con formato limpio</p>
          </div>
          <div class="option-card" data-format="docx">
            <div class="option-icon">📝</div>
            <h4>DOCX</h4>
            <p>Compatible con Microsoft Word</p>
          </div>
        </div>

        <!-- Language & Mode -->
        <div
          style="
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
            margin: 25px 0;
          "
        >
          <div style="flex: 1; min-width: 200px">
            <label style="font-weight: 600; display: block; margin-bottom: 6px"
              >🌐 Idioma</label
            >
            <select
              id="languageSelect"
              style="
                width: 100%;
                padding: 10px;
                border: 1px solid #ccc;
                border-radius: 8px;
              "
            >
              <option value="spanish" selected>Español (forzado)</option>
              <option value="english">Inglés</option>
              <option value="portuguese">Portugués</option>
              <option value="french">Francés</option>
              <option value="german">Alemán</option>
              <option value="italian">Italiano</option>
              <option value="auto">Detección automática</option>
            </select>
          </div>
          <div style="flex: 1; min-width: 220px">
            <label style="font-weight: 600; display: block; margin-bottom: 6px"
              >⚙️ Modo de Procesamiento</label
            >
            <select
              id="modeSelect"
              style="
                width: 100%;
                padding: 10px;
                border: 1px solid #ccc;
                border-radius: 8px;
              "
            >
              <option value="sync" selected>Directo (espera respuesta)</option>
              <option value="async">Cola (asíncrono)</option>
            </select>
            <small style="color: #6c757d"
              >Usa cola si el audio es largo o el modelo es grande</small
            >
          </div>
          <div style="flex: 1; min-width: 200px">
            <label style="font-weight: 600; display: block; margin-bottom: 6px"
              >🧠 Modelo Activo</label
            >
            <div
              id="modelInfo"
              style="
                padding: 10px;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                background: #fafafa;
                font-size: 13px;
                min-height: 48px;
                display: flex;
                align-items: center;
              "
            >
              (cargando...)
            </div>
          </div>
        </div>

        <!-- Panel Diagnóstico -->
        <details
          id="diagnosticsPanel"
          style="
            margin: 10px 0 25px;
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 14px;
          "
        >
          <summary
            style="
              cursor: pointer;
              font-weight: 600;
              display: flex;
              align-items: center;
              gap: 6px;
            "
          >
            🔎 Panel de Diagnóstico
          </summary>
          <div
            id="diagContent"
            style="
              margin-top: 12px;
              font-size: 13px;
              line-height: 1.4;
              color: #333;
              white-space: pre-wrap;
              overflow-x: auto;
              max-height: 260px;
            "
          ></div>
          <button
            type="button"
            id="refreshDiagBtn"
            style="
              margin-top: 10px;
              padding: 6px 14px;
              background: #4caf50;
              color: #fff;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              font-size: 13px;
            "
          >
            Actualizar
          </button>
        </details>

        <!-- Submit Section -->
        <div class="submit-section">
          <button
            class="submit-btn"
            id="submitBtn"
            onclick="transcribeAudio()"
            disabled
          >
            🚀 Iniciar Transcripción
          </button>
        </div>

        <!-- Progress Section -->
        <div class="progress-section" id="progressSection">
          <h4>Procesando archivo...</h4>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <p id="progressText">
            Esto puede tomar varios minutos dependiendo del tamaño del archivo
          </p>
        </div>

        <!-- Status Messages -->
        <div class="status-message" id="statusMessage"></div>

        <!-- Download Section -->
        <div class="download-section" id="downloadSection">
          <h3>✅ ¡Transcripción Completada!</h3>
          <p>Tu archivo ha sido procesado exitosamente</p>
          <button class="download-btn" id="downloadBtn">
            📥 Descargar Transcripción
          </button>
        </div>
      </div>

      <!-- Footer -->
      <div class="footer">
        <div style="max-width: 800px; margin: 0 auto; text-align: center">
          <div
            style="
              display: flex;
              justify-content: center;
              align-items: center;
              gap: 20px;
              margin-bottom: 15px;
              flex-wrap: wrap;
            "
          >
            <span style="display: flex; align-items: center; gap: 5px">
              🤖 <strong>OpenAI Whisper Medium</strong>
            </span>
            <span style="display: flex; align-items: center; gap: 5px">
              🐍 <strong>Flask + Python</strong>
            </span>
            <span style="display: flex; align-items: center; gap: 5px">
              🎨 <strong>AudioTranscript v1.0</strong>
            </span>
          </div>

          <div style="margin: 15px 0; font-size: 13px; color: #8e9aaf">
            Transcripción inteligente de audio optimizada para español | Soporta
            archivos hasta 1GB
          </div>

          <div
            style="
              display: flex;
              justify-content: center;
              gap: 25px;
              margin: 15px 0;
              flex-wrap: wrap;
            "
          >
            <a
              href="https://www.linkedin.com/in/taylorasprilla/"
              target="_blank"
              style="
                color: #4caf50;
                text-decoration: none;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 5px;
              "
            >
              <i class="fa fa-linkedin" aria-hidden="true"></i>
              linkedin.com/in/taylorasprilla/
            </a>
            <a
              href="https://github.com/TaylorAsprilla/AudioTranscript"
              target="_blank"
              style="
                color: #4caf50;
                text-decoration: none;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 5px;
              "
            >
              📦 GitHub
            </a>
            <a
              href="mailto:taylor.asprilla@gmail.com"
              style="
                color: #4caf50;
                text-decoration: none;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 5px;
              "
            >
              📧 Contacto
            </a>
          </div>

          <div
            style="
              font-size: 12px;
              color: #9ca3af;
              margin-top: 15px;
              padding-top: 15px;
              border-top: 1px solid #e5e7eb;
            "
          >
            © 2025 Taylor Asprilla | Hecho con ❤️ para la comunidad hispana
          </div>
        </div>
      </div>
    </div>

    <script>
      // Variables globales
      const API_BASE_URL = (function () {
        // Si estamos en protocolo file://, usar localhost:5000
        if (window.location.protocol === "file:") {
          return "http://localhost:5000";
        }
        // Si estamos en localhost en el navegador, usar localhost:5000
        if (
          window.location.hostname === "localhost" ||
          window.location.hostname === "127.0.0.1"
        ) {
          return "http://localhost:5000";
        }
        // Para producción, usar la URL actual
        return `${window.location.protocol}//${window.location.host}`;
      })();

      let selectedFile = null;
      let selectedFormat = "pdf";
      let downloadBlob = null;
      let downloadFilename = null;
      let currentJobId = null;
      let asyncPollingTimer = null;
      let queueEnabled = false;

      // Elementos DOM
      const fileInput = document.getElementById("audioFile");
      const fileInfo = document.getElementById("fileInfo");
      const submitBtn = document.getElementById("submitBtn");
      const uploadSection = document.getElementById("uploadSection");
      const progressSection = document.getElementById("progressSection");
      const downloadSection = document.getElementById("downloadSection");
      const statusMessage = document.getElementById("statusMessage");

      // Inicialización
      document.addEventListener("DOMContentLoaded", function () {
        checkApiStatus();
        fetchApiInfo();
        setupEventListeners();
      });

      // Configurar event listeners
      function setupEventListeners() {
        // File input change
        fileInput.addEventListener("change", handleFileSelect);

        // Format selection
        document.querySelectorAll(".option-card").forEach((card) => {
          card.addEventListener("click", function () {
            document
              .querySelectorAll(".option-card")
              .forEach((c) => c.classList.remove("selected"));
            this.classList.add("selected");
            selectedFormat = this.getAttribute("data-format");
          });
        });

        // Drag and drop
        uploadSection.addEventListener("dragover", function (e) {
          e.preventDefault();
          this.classList.add("dragover");
        });

        uploadSection.addEventListener("dragleave", function (e) {
          e.preventDefault();
          this.classList.remove("dragover");
        });

        uploadSection.addEventListener("drop", function (e) {
          e.preventDefault();
          this.classList.remove("dragover");
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect();
          }
        });

        const refreshDiagBtn = document.getElementById("refreshDiagBtn");
        refreshDiagBtn.addEventListener("click", fetchApiInfo);
      }

      async function fetchApiInfo() {
        try {
          const res = await fetch(`${API_BASE_URL}/api`, { cache: "no-cache" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          queueEnabled = !!data.queue_enabled;
          const modelInfoDiv = document.getElementById("modelInfo");
          modelInfoDiv.textContent =
            data.model_active + (data.lazy_loaded ? "" : " (no cargado aún)");
          const diag = {
            model_requested: data.model_requested,
            model_active: data.model_active,
            lazy_loaded: data.lazy_loaded,
            languages_supported: data.languages_supported,
            queue_enabled: data.queue_enabled,
            chunk_seconds: data.chunk_seconds,
            supported_formats: data.supported_formats,
            max_file_size: data.max_file_size,
            endpoints: data.endpoints,
          };
          document.getElementById("diagContent").textContent = JSON.stringify(
            diag,
            null,
            2
          );
          if (!data.queue_enabled) {
            const modeSelect = document.getElementById("modeSelect");
            modeSelect.value = "sync";
            modeSelect.disabled = true;
          }
        } catch (e) {
          document.getElementById("modelInfo").textContent =
            "Error obteniendo info";
          console.error("Error API info:", e);
        }
      }

      // Verificar estado de la API
      async function checkApiStatus() {
        const indicator = document.getElementById("statusIndicator");
        const statusText = document.getElementById("statusText");
        const statusDetails = document.getElementById("statusDetails");

        try {
          statusText.textContent = "Verificando...";
          console.log("🔍 Verificando API en:", `${API_BASE_URL}/health`);

          const response = await fetch(`${API_BASE_URL}/health`, {
            method: "GET",
            headers: {
              Accept: "application/json",
            },
            cache: "no-cache",
          });

          console.log(
            "📡 Respuesta recibida:",
            response.status,
            response.statusText
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const ct = response.headers.get("content-type") || "";
          if (!ct.includes("application/json")) {
            const text = await response.text();
            throw new Error(
              `Respuesta no-JSON desde /health. Posible proxy/error de plataforma. Detalles: ${
                text && text.trim().startsWith("<")
                  ? "Se recibió HTML (p.ej. página 502/404)."
                  : text?.substring(0, 200) || "(sin cuerpo)"
              }`
            );
          }

          const data = await response.json();
          console.log("📦 Datos recibidos:", data);

          if (data.status === "OK") {
            indicator.className = "status-indicator";
            statusText.innerHTML = "✅ API Conectada";
            statusDetails.textContent = `Modelo cargado: ${
              data.model_loaded ? "Sí" : "No"
            }`;
            console.log("✅ API conectada exitosamente");
          } else {
            throw new Error("Estado no válido en respuesta");
          }
        } catch (error) {
          indicator.className = "status-indicator status-offline";
          statusText.innerHTML = "❌ API Desconectada";

          // Mensajes de error más específicos
          if (error.name === "TypeError" && error.message.includes("fetch")) {
            statusDetails.textContent =
              "Error de conexión - Verifique CORS y servidor";
          } else if (error.message.includes("HTTP")) {
            statusDetails.textContent = `Error del servidor: ${error.message}`;
          } else {
            statusDetails.textContent = `Error: ${error.message}`;
          }

          console.error("❌ Error de API:", error);
          console.error("🔧 URL utilizada:", `${API_BASE_URL}/health`);
        }
      }

      // Manejar selección de archivo
      function handleFileSelect() {
        const file = fileInput.files[0];
        if (!file) return;

        selectedFile = file;

        // Mostrar información del archivo
        document.getElementById("fileName").textContent = file.name;
        document.getElementById("fileSize").textContent = formatFileSize(
          file.size
        );
        document.getElementById("fileType").textContent =
          file.type || "Desconocido";

        fileInfo.style.display = "block";
        submitBtn.disabled = false;
        submitBtn.textContent = `🚀 Transcribir ${file.name}`;

        // Validar tamaño
        if (file.size > 1073741824) {
          // 1GB
          showStatusMessage(
            "error",
            "❌ El archivo es demasiado grande. Máximo permitido: 1GB"
          );
          submitBtn.disabled = true;
          return;
        }

        hideStatusMessage();
      }

      // Iniciar transcripción
      async function transcribeAudio() {
        if (!selectedFile) {
          showStatusMessage(
            "error",
            "❌ Por favor selecciona un archivo de audio"
          );
          return;
        }

        // Preparar UI
        submitBtn.disabled = true;
        submitBtn.textContent = "⏳ Procesando...";
        progressSection.style.display = "block";
        downloadSection.style.display = "none";
        hideStatusMessage();

        // Simular progreso
        let progress = 0;
        const progressFill = document.getElementById("progressFill");
        const progressText = document.getElementById("progressText");

        const progressInterval = setInterval(() => {
          progress += Math.random() * 5;
          if (progress > 90) progress = 90;
          progressFill.style.width = progress + "%";
        }, 1000);

        try {
          // Crear FormData
          const formData = new FormData();
          formData.append("audio", selectedFile);
          formData.append("format", selectedFormat);
          formData.append(
            "lang",
            document.getElementById("languageSelect").value
          );
          const mode = document.getElementById("modeSelect").value;

          // Enviar petición
          let response;
          if (mode === "async" && queueEnabled) {
            response = await fetch(`${API_BASE_URL}/transcribe_async`, {
              method: "POST",
              body: formData,
            });
          } else {
            response = await fetch(`${API_BASE_URL}/transcribe`, {
              method: "POST",
              body: formData,
            });
          }

          clearInterval(progressInterval);
          progressFill.style.width = "100%";

          if (
            response.ok &&
            response.headers
              .get("content-type")
              ?.includes("application/json") &&
            document.getElementById("modeSelect").value === "async"
          ) {
            // Respuesta de job async
            const data = await response.json();
            if (data.job_id) {
              currentJobId = data.job_id;
              progressFill.style.width = "2%";
              progressText.textContent = "Tarea en cola...";
              pollAsyncJob();
              return; // no continuar con descarga directa
            }
          }

          if (response.ok) {
            // Obtener blob y filename
            downloadBlob = await response.blob();

            const contentDisposition = response.headers.get(
              "Content-Disposition"
            );
            downloadFilename = "transcripcion." + selectedFormat;
            if (contentDisposition) {
              const match = contentDisposition.match(/filename="(.+)"/);
              if (match) downloadFilename = match[1];
            }

            // Mostrar sección de descarga
            progressSection.style.display = "none";
            downloadSection.style.display = "block";

            document.getElementById("downloadBtn").onclick = function () {
              downloadFile();
            };

            showStatusMessage(
              "success",
              "✅ ¡Transcripción completada exitosamente!"
            );
          } else {
            // Intentar leer error como JSON; si no es JSON, leer como texto
            const contentType = response.headers.get("content-type") || "";
            let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
            try {
              if (contentType.includes("application/json")) {
                const errorData = await response.json();
                errorMessage = errorData.error || errorMessage;
              } else {
                const text = await response.text();
                // Si el servidor devolvió HTML (p. ej., <!DOCTYPE ...>), dar un mensaje más claro
                if (text && text.trim().startsWith("<")) {
                  errorMessage +=
                    " - El servidor devolvió una página HTML (posible 502/404/500 en Render).";
                } else if (text) {
                  errorMessage += ` - ${text.substring(0, 500)}`;
                }
              }
            } catch (parseErr) {
              // Si falla el parseo, mantener el mensaje base
              console.warn("No se pudo parsear el cuerpo de error:", parseErr);
            }
            throw new Error(errorMessage);
          }
        } catch (error) {
          clearInterval(progressInterval);
          progressSection.style.display = "none";
          showStatusMessage("error", `❌ Error: ${error.message}`);
          console.error("Error:", error);
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "🚀 Iniciar Transcripción";
        }
      }

      async function pollAsyncJob() {
        if (!currentJobId) return;
        try {
          const res = await fetch(`${API_BASE_URL}/jobs/${currentJobId}`, {
            cache: "no-cache",
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          if (data.status === "processing") {
            const pct = data.progress || 5;
            document.getElementById("progressFill").style.width = pct + "%";
            document.getElementById(
              "progressText"
            ).textContent = `Procesando (${pct}%)...`;
          } else if (data.status === "done") {
            document.getElementById("progressFill").style.width = "100%";
            document.getElementById("progressText").textContent = "Completado";
            // Descargar
            const dl = await fetch(
              `${API_BASE_URL}/jobs/${currentJobId}/download`
            );
            if (dl.ok) {
              downloadBlob = await dl.blob();
              downloadFilename =
                dl.headers
                  .get("Content-Disposition")
                  ?.match(/filename="(.+)"/)?.[1] ||
                "transcripcion." + selectedFormat;
              progressSection.style.display = "none";
              downloadSection.style.display = "block";
              document.getElementById("downloadBtn").onclick = function () {
                downloadFile();
              };
              showStatusMessage("success", "✅ ¡Transcripción completada!");
            } else {
              showStatusMessage("error", "Error al descargar el resultado");
            }
            currentJobId = null;
            return;
          } else if (data.status === "error") {
            showStatusMessage(
              "error",
              "❌ Error: " + (data.error || "Fallo en tarea")
            );
            progressSection.style.display = "none";
            currentJobId = null;
            return;
          }
        } catch (e) {
          console.error("Error polling job:", e);
        }
        if (currentJobId) {
          asyncPollingTimer = setTimeout(pollAsyncJob, 2500);
        }
      }

      // Descargar archivo
      function downloadFile() {
        if (!downloadBlob || !downloadFilename) return;

        const url = URL.createObjectURL(downloadBlob);
        const a = document.createElement("a");
        a.href = url;
        a.download = downloadFilename;
        a.style.display = "none";

        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        URL.revokeObjectURL(url);

        showStatusMessage(
          "success",
          `✅ Archivo "${downloadFilename}" descargado correctamente`
        );
      }

      // Utilidades
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function showStatusMessage(type, message) {
        statusMessage.className = `status-message status-${type}`;
        statusMessage.textContent = message;
        statusMessage.style.display = "block";

        if (type === "success") {
          setTimeout(hideStatusMessage, 5000);
        }
      }

      function hideStatusMessage() {
        statusMessage.style.display = "none";
      }

      console.log("🔗 AudioTranscript inicializado");
      console.log("📡 API URL:", API_BASE_URL);
    </script>
  </body>
</html>
